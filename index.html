<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>マルチブラウザ対応 音源プレイヤー</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <style>
    body {
      font-family: sans-serif;
      text-align: center;
      margin-top: 50px;
    }
    label, input[type=range] {
      font-size: 18px;
      display: inline-block;
      padding: 10px 20px;
      margin: 10px;
      background: #4CAF50;
      color: white;
      border-radius: 8px;
      cursor: pointer;
    }
    input[type=file] {
      display: none;
    }
    input[type=range] {
      background: none;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <h1>音源プレイヤー（Windows / Android / iPad / iPhone 対応）</h1>

  <!-- labelでfile inputを開く：全ブラウザで安定 -->
  <label for="fileInput">音源を読み込む</label>
  <input id="fileInput" type="file" accept=".mp3,.m4a,audio/*" multiple>

  <br>
  <label style="background:#333;">
    音量：
    <input id="volumeSlider" type="range" min="0" max="1" step="0.01" value="1">
  </label>

  <p>音源を読み込んだあと、クリック・タップ・キー押下で再生できます。</p>

  <script>
    const fileInput = document.getElementById('fileInput');
    const volumeSlider = document.getElementById('volumeSlider');

    let audioFiles = [];
    let currentIndex = 0;
    let isPlaying = false;
    let audioElement = new Audio();
    audioElement.preload = 'auto';

    // iOS Safari / Chrome 対策用：AudioContext unlock
    let audioCtx;
    let isAudioUnlocked = false;
    function unlockAudio() {
      if (!isAudioUnlocked) {
        try {
          audioCtx = new (window.AudioContext || window.webkitAudioContext)();
          const buffer = audioCtx.createBuffer(1, 1, audioCtx.sampleRate);
          const source = audioCtx.createBufferSource();
          source.buffer = buffer;
          source.connect(audioCtx.destination);
          source.start(0);
          isAudioUnlocked = true;
          console.log('AudioContext unlocked!');
        } catch (e) {
          console.warn('AudioContext unlock failed:', e);
        }
      }
    }
    document.addEventListener('touchstart', unlockAudio, { once: true });
    document.addEventListener('click', unlockAudio, { once: true });
    document.addEventListener('keydown', unlockAudio, { once: true });

    // ファイル読み込み
    fileInput.addEventListener('change', () => {
      const files = Array.from(fileInput.files);
      if (files.length > 0) {
        audioFiles = files;
        currentIndex = 0;
        alert(`${files.length}件の音源を読み込みました！`);
      }
    });

    // 音量調整
    volumeSlider.addEventListener('input', () => {
      audioElement.volume = volumeSlider.value;
    });

    // 再生処理
    function tryPlay() {
      if (isPlaying || audioFiles.length === 0) return;

      const file = audioFiles[currentIndex];
      const url = URL.createObjectURL(file);
      audioElement.src = url;
      audioElement.volume = volumeSlider.value;

      isPlaying = true;
      audioElement.play().catch(err => {
        console.error('再生エラー:', err);
        isPlaying = false;
      });

      audioElement.onended = () => {
        isPlaying = false;
        URL.revokeObjectURL(url);
        currentIndex++;
        if (currentIndex >= audioFiles.length) {
          currentIndex = 0;
        }
      };
    }

    // ユーザー操作で再生
    document.body.addEventListener('click', tryPlay);
    document.body.addEventListener('touchstart', tryPlay);
    document.body.addEventListener('keydown', tryPlay);
  </script>
</body>
</html>
